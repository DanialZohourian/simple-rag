{% extends "base.html" %}
{% block content %}

<div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
  <section class="lg:col-span-2 glass rounded-2xl p-6 soft-border shadow-glow">
    <h2 class="text-lg font-semibold">Ask</h2>
    <p class="text-sm text-slate-400 mt-1">
      Retrieves top 6 chunks from Chroma and calls <span class="text-slate-300">openai/gpt-4o</span> via OpenRouter.
    </p>

    <form class="mt-6 space-y-4" method="post" action="{{ url_for('ask_submit') }}">
      <div>
        <label class="block text-sm text-slate-300 mb-2">Question</label>
        <textarea name="question" required rows="7"
                  class="w-full rounded-lg px-3 py-2 text-sm glass soft-border focus:outline-none focus:ring-2 focus:ring-indigo-500/40"
                  placeholder="Ask something specific. Vague questions will produce vague answers.">{{ question or "" }}</textarea>
      </div>

      <button type="submit"
              class="w-full rounded-xl bg-indigo-600/25 hover:bg-indigo-600/35 transition soft-border px-4 py-3 text-sm font-semibold">
        Ask
      </button>

      <div class="text-xs text-slate-500">
        If you have zero files indexed, retrieval returns nothing. That’s on you.
      </div>
    </form>
  </section>

  <section class="lg:col-span-3 glass rounded-2xl p-6 soft-border">
    <h2 class="text-lg font-semibold">Answer</h2>

    {% if answer %}
      <div class="mt-4 rounded-xl p-5 bg-slate-900/35 soft-border">
        <div class="prose prose-invert max-w-none prose-p:leading-relaxed prose-a:text-indigo-300">
          {{ answer | replace("\n", "<br/>") | safe }}
        </div>
      </div>

      <div class="mt-6 flex items-center justify-between">
        <h3 class="text-base font-semibold">Retrieved context</h3>
        <div class="text-xs text-slate-500">{{ sources|length }} chunk(s)</div>
      </div>

      <div class="mt-3 space-y-3">
        {% for s in sources %}
          <details class="rounded-xl bg-slate-900/30 soft-border overflow-hidden">
            <summary class="cursor-pointer px-4 py-3 flex items-center justify-between gap-4">
              <div class="min-w-0">
                <div class="text-sm font-semibold truncate">
                  [{{ loop.index }}] {{ s.metadata.file_name }}
                </div>
                <div class="text-xs text-slate-400 mt-0.5">
                  page: {{ s.metadata.page_number }} • chunk: {{ s.metadata.chunk_number }}
                  {% if s.distance is not none %} • distance: {{ s.distance|round(4) }}{% endif %}
                </div>
              </div>
              <div class="text-xs text-slate-500">expand</div>
            </summary>
            <div class="px-4 pb-4 text-sm text-slate-200">
              <div class="mt-2 whitespace-pre-wrap">{{ s.document }}</div>
            </div>
          </details>
        {% endfor %}
      </div>
    {% else %}
      <div class="mt-4 rounded-xl p-6 bg-slate-900/30 soft-border text-sm text-slate-400">
        No answer yet. Ask a question.
      </div>
    {% endif %}
  </section>
</div>

{% endblock %}
